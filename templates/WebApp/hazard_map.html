{% extends "WebApp/app_base.html" %}
{% load static i18n %}

{% block title %}{% trans "Hazard Map Viewer" %}{% endblock %}

{% block script %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-loading@0.1.23/src/Control.Loading.css" />
<style>
  #map { height: 80vh; border-radius: 8px; }
  .leaflet-top.leaflet-left {
    top: 10px !important;
  }
  .control-panel {
    position: absolute;
    top: 120px; left: 20px; z-index: 999;
    background: white; padding: 12px 15px;
    border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.2);
    width: 320px;
  }
  .instructions-panel {
    position: absolute;
    top: 80px; right: 20px; z-index: 999;
    background: #f8f9fa; padding: 12px 15px;
    border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.2);
    width: 300px; font-size: 0.9rem;
  }
  .badge-stage { margin: 2px; }
  #ts-chart {
  width: 100%;
  height: 300px;
}
</style>
<script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet-loading@0.1.23/src/Control.Loading.js"></script>

<script>
let map, rasterLayer, currentHazardId = null;
let hazardTypeMap = {}, currentHazardType = '';
let strategyDataByVC = {}, timeseriesGroups = {};
let selectedProvince = '', defaultGroup = "";

document.addEventListener("DOMContentLoaded", () => {
  map = L.map("map").setView([-18.6, 35.5], 5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  map.addControl(new L.Control.Loading());

  fetch("/api/hazards/")
    .then(res => res.json())
    .then(data => {
      const typeSelect = document.getElementById("hazard-type-select");
      hazardTypeMap = data.reduce((acc, item) => {
        const hazardName = item.hazard;
        const label = item.name;
        if (!acc[hazardName]) acc[hazardName] = [];
        acc[hazardName].push({ id: item.hazard_id, label, layerName: item.geoserver_layer_name });
        return acc;
      }, {});
      Object.keys(hazardTypeMap).forEach(hazard => {
        const option = document.createElement("option");
        option.value = hazard;
        option.textContent = hazard;
        typeSelect.appendChild(option);
      });
    });

  document.getElementById("hazard-type-select").addEventListener("change", e => {
    const layerSelect = document.getElementById("hazard-layer-select");
    layerSelect.innerHTML = `<option value="">-- Select layer --</option>`;
    currentHazardType = e.target.value;
    (hazardTypeMap[e.target.value] || []).forEach(item => {
      const option = document.createElement("option");
      option.value = item.layerName;
      option.textContent = item.label;
      option.dataset.id = item.id;
      layerSelect.appendChild(option);
    });
  });

  document.getElementById("hazard-layer-select").addEventListener("change", e => {
    const selectedOption = e.target.selectedOptions[0];
    currentHazardId = selectedOption.dataset.id;
    const layerName = e.target.value;
    defaultGroup = layerName;

    if (rasterLayer) map.removeLayer(rasterLayer);
    if (layerName) {
      map.fire("dataloading");
      rasterLayer = L.tileLayer.wms("https://crva.jcdevops.com/geoserver/wms", {
        layers: layerName,
        format: "image/png",
        transparent: true,
        version: "1.1.1"
      })
      .on("load", () => map.fire("dataload"))
      .on("tileloadstart", () => map.fire("dataloading"))
      .on("tileload", () => map.fire("dataload"))
      .addTo(map);
    }
  });

  map.fire("dataloading");
  fetch("/api/provinces/")
    .then(res => res.json())
    .then(data => {
      const provinceLayer = L.geoJSON(data, {
        onEachFeature: (feature, layer) => {
          const props = feature.properties;
          layer.bindPopup(`<strong>${props.name}</strong><br><i>Click to view data</i>`);
          layer.on("click", () => {
            if (currentHazardId && currentHazardType) {
              selectedProvince = props.name;
              showHazardPopup(currentHazardId, currentHazardType, selectedProvince);
            } else {
              alert("Please select a hazard layer first.");
            }
          });
        },
        style: { color: "#000", fillOpacity: 0.0, weight: 1.5 }
      });
      provinceLayer.addTo(map);
      map.fire("dataload");
    });
});

function showHazardPopup(hazardId, hazardType, provinceName) {
  const stageOrder = [
    "Provision of inputs",
    "On farm production",
    "Post harvest and local processing",
    "Product marketing",
    "Consumption"
  ];

  Promise.all([
    fetch(`/api/strategies-by-hazard/?hazard=${hazardId}&province=${provinceName}`).then(res => res.json()),
    fetch(`/api/timeseries/?hazard=${hazardId}&province=${provinceName}`).then(res => res.json())
  ]).then(([strategyData, timeseriesData]) => {
    strategyDataByVC = groupBy(strategyData, "value_chain");
    timeseriesGroups = timeseriesData;

    const groupNames = Object.keys(timeseriesGroups);
    const selectedGroup = groupNames.find(g => timeseriesGroups[g].layer_name === defaultGroup) || groupNames[0];

    let html = `
      <div class="d-flex justify-content-between mb-3">
        <div>
          <h5 class="mb-1">${hazardType} in ${provinceName}</h5>
          <small class="text-muted">Explore data for selected hazard and province.</small>
        </div>
        <div class="btn-group" role="group">
          <button type="button" id="btn-timeseries" class="btn btn-sm btn-outline-secondary active" onclick="toggleView('timeseries')">Time Series</button>
          <button type="button" id="btn-strategies" class="btn btn-sm btn-outline-success" onclick="toggleView('strategies')">Adpatation Strategies</button>
        </div>
      </div>

      <div id="view-timeseries" class="px-2">
        <div class="card shadow-sm border-light mb-3">
          <div class="card-body">
            <h6 class="card-title mb-3"><i class="fas fa-chart-line me-2"></i>Time Series Chart</h6>
            <div class="mb-3">
              <label for="timeseries-group-select" class="form-label">Select Dataset</label>
              <select id="timeseries-group-select" class="form-select form-select-sm" onchange="renderTimeseriesChart(this.value)">
                ${groupNames.map(group => {
                  const selected = timeseriesGroups[group].layer_name === defaultGroup ? "selected" : "";
                  return `<option value="${group}" ${selected}>${group}</option>`;
                }).join("")}
              </select>
            </div>
            <div style="position:relative;">
              <canvas id="ts-chart" style="max-height: 320px; width: 100%;"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div id="view-strategies" style="display:none;">
        <ul class="nav nav-tabs mb-2">
          ${Object.keys(strategyDataByVC).map((vc, idx) => `
            <li class="nav-item">
              <button class="nav-link vc-tab ${idx === 0 ? "active" : ""}" data-target="tab-${idx}">${vc}</button>
            </li>`).join("")}
        </ul>
        <div class="tab-content">
          ${Object.entries(strategyDataByVC).map(([vc, records], idx) => {
            const sortedRecords = [...records].sort((a, b) => {
              const indexA = stageOrder.indexOf(a.stage);
              const indexB = stageOrder.indexOf(b.stage);
              return indexA - indexB;
            });

            return `
              <div class="tab-pane fade ${idx === 0 ? "show active" : ""}" id="tab-${idx}">
                <div class="mb-2">
                  <strong>Province:</strong> ${provinceName}, 
                  <strong>Hazard:</strong> ${hazardType}, 
                  <strong>Value Chain:</strong> ${vc}
                </div>
                <table class="table table-sm table-bordered">
                  <thead>
                    <tr>
                      <th style="width:25%;">Stage</th>
                      <th style="width:35%;">Impact</th>
                      <th>Strategy</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${sortedRecords.map(r => `
                      <tr>
                        <td><span class="badge bg-primary">${r.stage}</span></td>
                        <td>${r.risk}</td>
                        <td>${r.strategy}</td>
                      </tr>`).join("")}
                  </tbody>
                </table>
              </div>`;
          }).join("")}
        </div>
      </div>
    `;

    document.getElementById("modal-content-placeholder").innerHTML = html;
    new bootstrap.Modal(document.getElementById("strategyModal")).show();

    renderTimeseriesChart(selectedGroup);

    document.querySelectorAll(".vc-tab").forEach(btn => {
      btn.addEventListener("click", function () {
        document.querySelectorAll(".vc-tab").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-pane").forEach(p => p.classList.remove("show", "active"));
        this.classList.add("active");
        const targetId = this.dataset.target;
        document.getElementById(targetId).classList.add("show", "active");
      });
    });
  });
}





function toggleView(view) {
  document.getElementById("view-timeseries").style.display = view === "timeseries" ? "" : "none";
  document.getElementById("view-strategies").style.display = view === "strategies" ? "" : "none";

  document.getElementById("btn-timeseries").classList.toggle("active", view === "timeseries");
  document.getElementById("btn-strategies").classList.toggle("active", view === "strategies");
}

function renderTimeseriesChart(group) {
  const ctx = document.getElementById("ts-chart").getContext("2d");
  const raw = timeseriesGroups[group] || { data: [] };
  const data = raw.data;

  const chartData = {
    labels: data.map(d => d.year),
    datasets: [{
      label: `Hazard Value (${group})`,
      data: data.map(d => d.value),
      borderColor: "#198754",
      pointBackgroundColor: "#198754",
      tension: 0.3,
      fill: true,
      backgroundColor: "rgba(25, 135, 84, 0.1)",
    }]
  };

  const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      tooltip: { mode: 'index', intersect: false },
      legend: { display: false },
      title: {
        display: false
      }
    },
    scales: {
      x: {
        title: {
          display: true,
          text: "Year",
          font: { size: 12 }
        }
      },
      y: {
        title: {
          display: true,
          text: "Value",
          font: { size: 12 }
        }
      }
    }
  };

  if (window.tsChart) window.tsChart.destroy();
  window.tsChart = new Chart(ctx, { type: "line", data: chartData, options: chartOptions });
}



function groupBy(array, key) {
  return array.reduce((acc, item) => {
    const k = item[key] || "Unnamed";
    acc[k] = acc[k] || [];
    acc[k].push(item);
    return acc;
  }, {});
}
</script>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>{% trans "Hazard Map Viewer" %}</h5>
        </div>
        <div class="card-body position-relative">
          <div id="map" class="mb-3"></div>
          <div class="control-panel">
            <label for="hazard-type-select" class="form-label fw-bold">{% trans "Hazard Type" %}</label>
            <select id="hazard-type-select" class="form-select form-select-sm mb-2"><option value="">{% trans "-- Select type --" %}</option></select>
            <label for="hazard-layer-select" class="form-label fw-bold">{% trans "Layer" %}</label>
            <select id="hazard-layer-select" class="form-select form-select-sm"><option value="">{% trans "-- Select layer --" %}</option></select>
          </div>
          <div class="instructions-panel">
            <h6><i class="fas fa-info-circle me-1"></i>Instructions</h6>
            <ul class="mb-0">
              <li>Select a hazard type and layer</li>
              <li>Click on a province on the map</li>
              <li>Explore strategies or time series</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="strategyModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title text-white">{% trans "Adaptation Strategies & Time Series" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modal-content-placeholder"></div>
    </div>
  </div>
</div>
{% endblock %}
