{% extends "WebApp/app_base.html" %}
{% load static i18n %}

{% block title %}{% trans "Hazard Map Viewer" %}{% endblock %}

{% block script %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-loading@0.1.23/src/Control.Loading.css" />

<style>
  #map { height: 80vh; border-radius: 8px; }
  .leaflet-top.leaflet-left { top: 10px !important; left: 10px !important; }

  /* Hide the old select panel if it exists in your base */
  .control-panel { display: none !important; }

  .instructions-panel {
    position: absolute;
    top: 80px; right: 20px; z-index: 999;
    background: #f8f9fa; padding: 12px 15px;
    border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.2);
    width: 300px; font-size: 0.9rem;
  }

  /* --- Floating legends (bottom-right) --- */
  .leaflet-bottom.leaflet-right { right: 10px; bottom: 10px; }
  .legend-control {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,.15);
    overflow: hidden;
    width: 260px;
    max-height: 320px;
    margin-top: 8px;         /* stack nicely if two legends */
  }
  .legend-control.hidden { display: none; } /* JS toggles this */
  .legend-header {
    display: flex; align-items: center; justify-content: space-between; gap: 8px;
    padding: 8px 10px; background: #198754; color: #fff;
    font-weight: 600; font-size: 0.95rem;
  }
  .legend-body { padding: 8px 10px; max-height: 270px; overflow: auto; }
  .legend-body img { width: 30%; height: auto; display: block; } /* was 30%, now full */
  .legend-toggle { background: transparent; border: 0; color: #fff; font-size: 16px; line-height: 1; cursor: pointer; }

  /* --- Floating Layers Tree (top-left) --- */
  .layer-tree-control {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,.15);
    overflow: hidden;
    width: 320px;
    display: flex;
    flex-direction: column;
    max-height: 70vh;
  }
  .layer-tree-header {
    display: flex; align-items: center; justify-content: space-between;
    gap: 8px; padding: 8px 10px; background: #0d6efd; color: #fff;
    font-weight: 600; font-size: .95rem;
  }
  .layer-tree-tools { display: flex; gap: 6px; }
  .layer-tree-tools button {
    background: rgba(255,255,255,.2); border: 0; color: #fff; font-size: 12px;
    padding: 4px 8px; border-radius: 6px; cursor: pointer;
  }
  .layer-tree-tools button:hover { background: rgba(255,255,255,.3); }
  .layer-tree-body { padding: 8px 10px; overflow: auto; display: flex; flex-direction: column; max-height: 50vh; }
  .layer-tree-search { width: 100%; margin-bottom: 8px; }
  .layer-tree-search input {
    width: 100%; padding: 6px 8px; border: 1px solid #dee2e6; border-radius: 6px; font-size: .9rem;
  }
  .tree-group { margin: 6px 0; }
  .tree-group-header {
    display: flex; align-items: center; gap: 8px; cursor: pointer;
    font-weight: 600; user-select: none; padding: 4px 2px;
  }
  .tree-group-header .caret { width: 16px; text-align: center; }
  .tree-group.collapsed .tree-items { display: none; }
  .tree-items { margin-left: 22px; margin-top: 6px; }
  .tree-item { display: flex; align-items: center; gap: 8px; padding: 2px 0; font-size: .92rem; }
  .tree-item input[type="radio"] { accent-color: #0d6efd; }
  .tree-item .layer-name { flex: 1; }
  .layer-tree-footer {
    display: flex; gap: 6px; padding-top: 8px; background: white; flex: 0 0 auto; justify-content: flex-end;
  }
  .layer-tree-footer button {
    flex: 1; background: #198754; color: #fff; border: 0; padding: 6px 16px; border-radius: 6px; font-size: .85rem; cursor: pointer;
  }
  .layer-tree-footer button.secondary { background: #6c757d; }
</style>

<script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet-loading@0.1.23/src/Control.Loading.js"></script>

<script>
let map, rasterLayer, currentHazardId = null;
let hazardTypeMap = {}, currentHazardType = '';
let strategyDataByVC = {}, timeseriesGroups = {};
let selectedProvince = '', defaultGroup = "";
let hazardLegendControl, boundaryLegendControl, layerTreeControl;
let boundariesWms;

/* ---- GeoServer config ---- */
const GEOSERVER_WMS = "https://crva.jcdevops.com/geoserver/wms";
const PROV_LAYER     = "crva:provinces";  // your provinces layer name
const PROV_STYLE     = "province_boundaries";                 // optional named style ('' keeps default)

/* ---------- Legend Control (generic) ---------- */
function createLegendControl(titleText, imgId) {
  return L.Control.extend({
    options: { position: "bottomright" },
    onAdd: function() {
      const div = L.DomUtil.create("div", "legend-control");
      div.innerHTML = `
        <div class="legend-header">
          <span>${titleText}</span>
          <button class="legend-toggle" title="{% trans 'Collapse/Expand' %}" aria-label="{% trans 'Collapse/Expand' %}">–</button>
        </div>
        <div class="legend-body">
          <img id="${imgId}" alt="Legend">
        </div>
      `;
      L.DomEvent.disableClickPropagation(div);
      const toggleBtn = div.querySelector(".legend-toggle");
      const body = div.querySelector(".legend-body");
      toggleBtn.addEventListener("click", () => {
        const isHidden = body.style.display === "none";
        body.style.display = isHidden ? "" : "none";
        toggleBtn.textContent = isHidden ? "–" : "+";
      });
      return div;
    }
  });
}

function setLegendImage(imgElementId, layerName, styleName) {
  const params = new URLSearchParams({
    REQUEST: "GetLegendGraphic",
    VERSION: "1.0.0",
    FORMAT: "image/png",
    TRANSPARENT: "true",
    LAYER: layerName,
    LEGEND_OPTIONS: "fontName:Arial;fontSize:12;fontAntiAliasing:true;forceLabels:on",
    _ts: Date.now().toString()
  });
  if (styleName) params.set("STYLE", styleName);
  const url = `${GEOSERVER_WMS}?${params.toString()}`;
  const img = document.getElementById(imgElementId);
  if (img) img.src = url;
}

/* ---------- Load hazard WMS + update hazard legend ---------- */
function selectLayer(layerName, hazardId) {
  currentHazardId = hazardId || null;
  defaultGroup = layerName;

  if (rasterLayer) map.removeLayer(rasterLayer);
  if (!layerName) {
    const el = hazardLegendControl.getContainer();
    el.classList.add("hidden");
    const img = document.getElementById("hazard-legend-img");
    if (img) img.src = "";
    return;
  }

  map.fire("dataloading");
  rasterLayer = L.tileLayer.wms(GEOSERVER_WMS, {
    layers: layerName,
    format: "image/png",
    transparent: true,
    version: "1.1.1",
     zIndex: 100   
  })
  .on("load", () => map.fire("dataload"))
  .on("tileloadstart", () => map.fire("dataloading"))
  .on("tileload", () => map.fire("dataload"))
  .addTo(map);

  if (typeof boundariesWms !== "undefined") {
  boundariesWms.bringToFront();
}

  // Show/update legend for selected hazard
  setLegendImage("hazard-legend-img", layerName, "");
  hazardLegendControl.getContainer().classList.remove("hidden");
}

/* ---------- Layer Tree Control (collapsible categories) ---------- */
const LayerTreeControl = L.Control.extend({
  options: { position: "topleft" },
  setData(data) { this._data = data || {}; this._renderTree(); },
  onAdd() {
    const div = L.DomUtil.create("div", "layer-tree-control");
    div.innerHTML = `
      <div class="layer-tree-header">
        <span><i class="fas fa-layer-group me-1"></i> Layers</span>
        <div class="layer-tree-tools">
          <button type="button" data-action="expand"><i class="fas fa-plus-square"></i> Expand</button>
          <button type="button" data-action="collapse"><i class="fas fa-minus-square"></i> Collapse</button>
        </div>
      </div>
      <div class="layer-tree-body">
        <div class="layer-tree-search">
          <input type="text" id="layer-search" placeholder="Search layers...">
        </div>
        <div id="layer-tree"></div>
      </div>
      <div class="layer-tree-footer">
        <button class="secondary" type="button" id="btn-clear-layer">Clear</button>
        <button type="button" id="btn-apply-layer">Apply</button>
      </div>
    `;
    L.DomEvent.disableClickPropagation(div);

    div.querySelector('[data-action="expand"]').addEventListener('click', () => this._setAllCollapsed(false));
    div.querySelector('[data-action="collapse"]').addEventListener('click', () => this._setAllCollapsed(true));

    div.querySelector('#btn-clear-layer').addEventListener('click', () => {
      const checked = div.querySelector('input[name="layer-radio"]:checked');
      if (checked) checked.checked = false;
      selectLayer(null, null);
    });

    div.querySelector('#btn-apply-layer').addEventListener('click', () => {
      const sel = div.querySelector('input[name="layer-radio"]:checked');
      if (!sel) return;
      const layerName = sel.value;
      const hazardId  = sel.dataset.id || null;
      selectLayer(layerName, hazardId);
    });

    div.querySelector('#layer-search').addEventListener('input', (e) => {
      this._filterTree(e.target.value.trim().toLowerCase());
    });

    this._root = div;
    this._treeEl = div.querySelector('#layer-tree');
    this._data = {};
    return div;
  },
  _renderTree() {
    const groups = Object.keys(this._data).sort((a, b) => a.localeCompare(b));
    this._treeEl.innerHTML = groups.map((grp) => {
      const items = this._data[grp] || [];
      const itemsHtml = items.map(it => `
        <div class="tree-item">
          <input type="radio" name="layer-radio" id="lyr-${it.id}" value="${it.layerName}" data-id="${it.id}">
          <label class="layer-name" for="lyr-${it.id}">
            ${it.label}
          </label>
        </div>
      `).join("");

      return `
        <div class="tree-group" data-group="${grp}">
          <div class="tree-group-header">
            <span class="caret"><i class="fas fa-caret-down"></i></span>
            <span class="group-name"><i class="fas fa-folder-open me-1 text-warning"></i>${grp}</span>
          </div>
          <div class="tree-items">
            ${itemsHtml}
          </div>
        </div>
      `;
    }).join("");

    // expand/collapse per group
    this._treeEl.querySelectorAll('.tree-group-header').forEach(h => {
      h.addEventListener('click', () => {
        const group = h.parentElement;
        const icon = h.querySelector('.caret i');
        const collapsed = group.classList.toggle('collapsed');
        icon.classList.toggle('fa-caret-right', collapsed);
        icon.classList.toggle('fa-caret-down', !collapsed);
        const folder = h.querySelector('.group-name i');
        folder.classList.toggle('fa-folder', collapsed);
        folder.classList.toggle('fa-folder-open', !collapsed);
      });
    });

    // OPTIONAL: auto-apply when a layer is clicked
    this._treeEl.querySelectorAll('input[name="layer-radio"]').forEach(r => {
      r.addEventListener('change', (e) => {
        selectLayer(e.target.value, e.target.dataset.id || null);
      });
    });
  },
  _setAllCollapsed(state) {
    this._treeEl.querySelectorAll('.tree-group').forEach(g => {
      const headerIcon = g.querySelector('.caret i');
      const folder = g.querySelector('.group-name i');
      g.classList.toggle('collapsed', state);
      headerIcon.classList.toggle('fa-caret-right', state);
      headerIcon.classList.toggle('fa-caret-down', !state);
      folder.classList.toggle('fa-folder', state);
      folder.classList.toggle('fa-folder-open', !state);
    });
  },
  _filterTree(q) {
    const groups = this._treeEl.querySelectorAll('.tree-group');
    groups.forEach(g => {
      const groupName = g.dataset.group.toLowerCase();
      const items = Array.from(g.querySelectorAll('.tree-item'));
      let anyVisible = false;
      items.forEach(it => {
        const name = it.querySelector('.layer-name').textContent.toLowerCase();
        const visible = !q || name.includes(q) || groupName.includes(q);
        it.style.display = visible ? '' : 'none';
        anyVisible = anyVisible || visible;
      });
      g.style.display = anyVisible || !q ? '' : 'none';
      if (q && g.classList.contains('collapsed')) {
        g.classList.remove('collapsed');
        const icon = g.querySelector('.caret i');
        icon.classList.remove('fa-caret-right'); icon.classList.add('fa-caret-down');
        const folder = g.querySelector('.group-name i');
        folder.classList.remove('fa-folder'); folder.classList.add('fa-folder-open');
      }
    });
  }
});

/* ---------- Timeseries/Strategies popup/modal ---------- */
function showHazardPopup(hazardId, hazardType, provinceName) {
  const stageOrder = ["Provision of inputs","On farm production","Post harvest and local processing","Product marketing","Consumption"];

  Promise.all([
    fetch(`/api/strategies-by-hazard/?hazard=${hazardId}&province=${provinceName}`).then(res => res.json()),
    fetch(`/api/timeseries/?hazard=${hazardId}&province=${provinceName}`).then(res => res.json())
  ]).then(([strategyData, timeseriesData]) => {
    strategyDataByVC = groupBy(strategyData, "value_chain");
    timeseriesGroups = timeseriesData;

    const groupNames = Object.keys(timeseriesGroups);
    const selectedGroup = groupNames.find(g => timeseriesGroups[g].layer_name === defaultGroup) || groupNames[0];

    let html = `
      <div class="d-flex justify-content-between mb-3">
        <div>
          <h5 class="mb-1">${hazardType} in ${provinceName}</h5>
          <small class="text-muted">Explore data for selected hazard and province.</small>
        </div>
        <div class="btn-group" role="group">
          <button type="button" id="btn-timeseries" class="btn btn-sm btn-outline-secondary active" onclick="toggleView('timeseries')">Time Series</button>
          <button type="button" id="btn-strategies" class="btn btn-sm btn-outline-success" onclick="toggleView('strategies')">Adaptation Strategies</button>
        </div>
      </div>

      <div id="view-timeseries" class="px-2">
        <div class="card shadow-sm border-light mb-3">
          <div class="card-body">
            <h6 class="card-title mb-3"><i class="fas fa-chart-line me-2"></i>Time Series Chart</h6>
            <div class="mb-3">
              <label for="timeseries-group-select" class="form-label">Select Dataset</label>
              <select id="timeseries-group-select" class="form-select form-select-sm" onchange="renderTimeseriesChart(this.value)">
                ${groupNames.map(group => {
                  const selected = timeseriesGroups[group].layer_name === defaultGroup ? "selected" : "";
                  return `<option value="${group}" ${selected}>${group}</option>`;
                }).join("")}
              </select>
            </div>
            <div style="position:relative;">
              <canvas id="ts-chart" style="max-height: 320px; width: 100%;"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div id="view-strategies" style="display:none;">
        <ul class="nav nav-tabs mb-2">
          ${Object.keys(strategyDataByVC).map((vc, idx) => `
            <li class="nav-item">
              <button class="nav-link vc-tab ${idx === 0 ? "active" : ""}" data-target="tab-${idx}">${vc}</button>
            </li>`).join("")}
        </ul>
        <div class="tab-content">
          ${Object.entries(strategyDataByVC).map(([vc, records], idx) => {
            const sortedRecords = [...records].sort((a, b) => stageOrder.indexOf(a.stage) - stageOrder.indexOf(b.stage));
            return `
              <div class="tab-pane fade ${idx === 0 ? "show active" : ""}" id="tab-${idx}">
                <div class="mb-2">
                  <strong>Province:</strong> ${provinceName},
                  <strong>Hazard:</strong> ${hazardType},
                  <strong>Value Chain:</strong> ${vc}
                </div>
                <table class="table table-sm table-bordered">
                  <thead>
                    <tr>
                      <th style="width:25%;">Stage</th>
                      <th style="width:35%;">Impact</th>
                      <th>Adaptation Strategy</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${sortedRecords.map(r => `
                      <tr>
                        <td><span class="badge bg-primary">${r.stage}</span></td>
                        <td>${r.risk}</td>
                        <td>${r.strategy}</td>
                      </tr>`).join("")}
                  </tbody>
                </table>
              </div>`;
          }).join("")}
        </div>
      </div>
    `;

    document.getElementById("modal-content-placeholder").innerHTML = html;
    new bootstrap.Modal(document.getElementById("strategyModal")).show();

    renderTimeseriesChart(selectedGroup);

    document.querySelectorAll(".vc-tab").forEach(btn => {
      btn.addEventListener("click", function () {
        document.querySelectorAll(".vc-tab").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-pane").forEach(p => p.classList.remove("show", "active"));
        this.classList.add("active");
        const targetId = this.dataset.target;
        document.getElementById(targetId).classList.add("show", "active");
      });
    });
  });
}

function toggleView(view) {
  document.getElementById("view-timeseries").style.display = view === "timeseries" ? "" : "none";
  document.getElementById("view-strategies").style.display = view === "strategies" ? "" : "none";
  document.getElementById("btn-timeseries").classList.toggle("active", view === "timeseries");
  document.getElementById("btn-strategies").classList.toggle("active", view === "strategies");
}

function renderTimeseriesChart(group) {
  const ctx = document.getElementById("ts-chart").getContext("2d");
  const raw = timeseriesGroups[group] || { data: [] };
  const data = raw.data;

  const chartData = {
    labels: data.map(d => d.year),
    datasets: [{
      label: `Hazard Value (${group})`,
      data: data.map(d => d.value),
      borderColor: "#198754",
      pointBackgroundColor: "#198754",
      tension: 0.3,
      fill: true,
      backgroundColor: "rgba(25, 135, 84, 0.1)",
    }]
  };

  const chartOptions = {
    responsive: true, maintainAspectRatio: false,
    plugins: { tooltip: { mode: 'index', intersect: false }, legend: { display: false }, title: { display: false } },
    scales: {
      x: { title: { display: true, text: "Year", font: { size: 12 } } },
      y: { title: { display: true, text: "Value", font: { size: 12 } } }
    }
  };

  if (window.tsChart) window.tsChart.destroy();
  window.tsChart = new Chart(ctx, { type: "line", data: chartData, options: chartOptions });
}

function groupBy(array, key) {
  return array.reduce((acc, item) => {
    const k = item[key] || "Unnamed";
    acc[k] = acc[k] || [];
    acc[k].push(item);
    return acc;
  }, {});
}

/* ---------- WMS GetFeatureInfo to pick province name ---------- */
async function identifyProvince(e) {
  if (!currentHazardId || !defaultGroup) {
    alert("{% trans 'Please select a hazard layer first.' %}");
    return;
  }

  // Use map's CRS (Leaflet default = EPSG:3857) for GetFeatureInfo
  const crs = L.CRS.EPSG3857;
  const size = map.getSize();
  const b = map.getBounds();
  const sw = crs.project(b.getSouthWest());
  const ne = crs.project(b.getNorthEast());

  const params = new URLSearchParams({
    SERVICE: "WMS",
    VERSION: "1.1.1",
    REQUEST: "GetFeatureInfo",
    LAYERS: PROV_LAYER,
    QUERY_LAYERS: PROV_LAYER,
    STYLES: PROV_STYLE || "",
    BBOX: `${sw.x},${sw.y},${ne.x},${ne.y}`,
    FEATURE_COUNT: "1",
    HEIGHT: size.y.toString(),
    WIDTH: size.x.toString(),
    FORMAT: "image/png",
    INFO_FORMAT: "application/json",
    SRS: "EPSG:3857",
    X: Math.round(e.containerPoint.x).toString(),
    Y: Math.round(e.containerPoint.y).toString(),

    // GeoServer vendor tolerances help a LOT for thin strokes/lines
    FI_POINT_TOLERANCE: "10",
    FI_LINE_TOLERANCE: "10",
    FI_POLYGON_TOLERANCE: "5"
  });

  try {
    const url = `${GEOSERVER_WMS}?${params.toString()}`;
    const json = await fetch(url).then(r => r.json());
    const feat = (json.features || [])[0];
    if (!feat) return;

    // adjust attribute keys to your schema
    const p = feat.properties || {};
    const provinceName = p.NAME_1 || p.NOME || p.province || p.name || "";
    if (!provinceName) {
      console.warn("No province name attribute found in GetFeatureInfo:", p);
      return;
    }

    currentHazardType = Object.keys(hazardTypeMap).find(h =>
      (hazardTypeMap[h] || []).some(x => x.layerName === defaultGroup)
    ) || "";

    showHazardPopup(currentHazardId, currentHazardType, provinceName);
  } catch (err) {
    console.error("GetFeatureInfo error:", err);
  }
}


/* ---------- Init ---------- */
document.addEventListener("DOMContentLoaded", () => {
  map = L.map("map").setView([-20.6, 36.5], 5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  map.addControl(new L.Control.Loading());

  // Provinces WMS (no client GeoJSON)
  boundariesWms = L.tileLayer.wms(GEOSERVER_WMS, {
    layers: PROV_LAYER,
    styles: PROV_STYLE || undefined,
    format: "image/png",
    transparent: true,
    version: "1.1.1",
    tiled: true,
    zIndex: 500  
  }).addTo(map);

  // Legends: Provinces (always visible) + Hazard (hidden until selected)
  const BoundaryLegend = createLegendControl("{% trans 'Provinces' %}", "boundary-legend-img");
  boundaryLegendControl = new BoundaryLegend({ position: "bottomright" }).addTo(map);
  setLegendImage("boundary-legend-img", PROV_LAYER, PROV_STYLE || "");

  const HazardLegend = createLegendControl("{% trans 'Legend' %}", "hazard-legend-img");
  hazardLegendControl = new HazardLegend({ position: "bottomright" }).addTo(map);
  hazardLegendControl.getContainer().classList.add("hidden");

  // Layer tree
  layerTreeControl = new LayerTreeControl({ position: "topleft" }).addTo(map);

  // Load hazards and fill the tree
  fetch("/api/hazards/")
    .then(res => res.json())
    .then(data => {
      hazardTypeMap = data.reduce((acc, item) => {
        const hazardName = item.hazard;
        const label = item.name;
        if (!acc[hazardName]) acc[hazardName] = [];
        acc[hazardName].push({ id: item.hazard_id, label, layerName: item.geoserver_layer_name });
        return acc;
      }, {});
      layerTreeControl.setData(hazardTypeMap);
    });

  // Identify province from WMS on click
  map.on("click", identifyProvince);
});
</script>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>{% trans "Hazard Map Viewer" %}</h5>
        </div>
        <div class="card-body position-relative">
          <div id="map" class="mb-3"></div>

          <div class="instructions-panel">
            <h6><i class="fas fa-info-circle me-1"></i>{% trans "Instructions" %}</h6>
            <ul class="mb-0 ps-3">
              <li>{% trans "Use the Layers panel (top-left) to pick a category and a layer, then click Apply" %}</li>
              <li>{% trans "Click on a province on the map" %}</li>
              <li>{% trans "Explore strategies or time series in the modal" %}</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="strategyModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title text-white">{% trans "Adaptation Strategies & Time Series" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modal-content-placeholder"></div>
    </div>
  </div>
</div>
{% endblock %}
