{% extends "WebApp/app_base.html" %}
{% load static i18n %}

{% block title %}{% trans "Hazard Map Viewer" %}{% endblock %}

{% block script %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<style>
  #map {
    height: 80vh;
    border-radius: 8px;
  }
  .control-panel {
    position: absolute;
    top: 80px;
    left: 20px;
    z-index: 999;
    background: white;
    padding: 12px 15px;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.2);
    width: 320px;
  }
  #view-strategies .table th {
  position: sticky;
  top: 0;
  background: #f8f9fa;
}

#view-strategies {
  max-height: 400px;
  overflow-y: auto;
}

.modal-body {
  font-size: 0.9rem;
}

.nav-tabs .nav-link {
  white-space: nowrap;
}

</style>
<script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let map, rasterLayer, currentHazardId = null;
let hazardTypeMap = {};
let currentHazardType = '';
let strategyDataByVC = {};
let timeseriesGroups = {};
let defaultGroup = "";

document.addEventListener("DOMContentLoaded", () => {
  map = L.map("map").setView([-18.6, 35.5], 5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  fetch("/api/hazards/")
    .then(res => res.json())
    .then(data => {
      const typeSelect = document.getElementById("hazard-type-select");
      hazardTypeMap = data.reduce((acc, item) => {
        const hazardName = item.hazard;
        const label = `${item.name}${item.scenario ? ' (' + item.scenario + ')' : ''}`;
        if (!acc[hazardName]) acc[hazardName] = [];
        acc[hazardName].push({ id: item.hazard_id, label, layerName: item.geoserver_layer_name });
        return acc;
      }, {});
      Object.keys(hazardTypeMap).forEach(hazard => {
        const option = document.createElement("option");
        option.value = hazard;
        option.textContent = hazard;
        typeSelect.appendChild(option);
      });
    });

  document.getElementById("hazard-type-select").addEventListener("change", e => {
    const layerSelect = document.getElementById("hazard-layer-select");
    layerSelect.innerHTML = `<option value="">-- Select layer --</option>`;
    currentHazardType = e.target.value;
    (hazardTypeMap[e.target.value] || []).forEach(item => {
      const option = document.createElement("option");
      option.value = item.layerName;
      option.textContent = item.label;
      option.dataset.id = item.id;
      layerSelect.appendChild(option);
    });
  });

  document.getElementById("hazard-layer-select").addEventListener("change", e => {
    const selectedOption = e.target.selectedOptions[0];
    currentHazardId = selectedOption.dataset.id;
    const layerName = e.target.value;
    defaultGroup = layerName;
    if (rasterLayer) map.removeLayer(rasterLayer);
    if (layerName) {
      rasterLayer = L.tileLayer.wms("http://localhost:8080/geoserver/wms", {
        layers: layerName,
        format: "image/png",
        transparent: true,
        version: "1.1.1"
      }).addTo(map);
    }
  });

  fetch("/api/provinces/")
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        onEachFeature: (feature, layer) => {
          const props = feature.properties;
          layer.bindPopup(`<strong>${props.name}</strong><br><i>Click to view data</i>`);
          layer.on("click", () => {
            if (currentHazardId && currentHazardType) {
              showHazardPopup(currentHazardId, currentHazardType, props.name);
            } else {
              alert("Please select a hazard layer first.");
            }
          });
        },
        style: {
          color: "#000", fillOpacity: 0.0, weight: 1.5
        }
      }).addTo(map);
    });
});

function showHazardPopup(hazardId, hazardType, provinceName) {
  Promise.all([
    fetch(`/api/strategies-by-hazard/?hazard=${hazardId}&province=${provinceName}`).then(res => res.json()),
    fetch(`/api/timeseries/?hazard=${hazardId}&province=${provinceName}`).then(res => res.json())
  ]).then(([strategyData, timeseriesData]) => {
    strategyDataByVC = groupBy(strategyData, "value_chain");
    timeseriesGroups = timeseriesData;

    let html = `
      <div class="d-flex justify-content-between mb-3">
        <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>${hazardType} – ${provinceName}</h5>
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-secondary active" onclick="toggleView('timeseries')">Time Series</button>
          <button class="btn btn-sm btn-outline-success" onclick="toggleView('strategies')">Strategies</button>
        </div>
      </div>
      <div id="view-timeseries">`;

    const groupNames = Object.keys(timeseriesGroups);
    html += `<select class="form-select form-select-sm mb-2" onchange="renderTimeseriesChart(this.value)">`;
    groupNames.forEach(group => {
      const selected = timeseriesGroups[group].layer_name === defaultGroup ? "selected" : "";
      html += `<option value="${group}" ${selected}>${group}</option>`;
    });
    html += `</select><canvas id="ts-chart" height="200"></canvas></div>`;

    html += `<div id="view-strategies" style="display:none;">`;
    const vcKeys = Object.keys(strategyDataByVC);
    html += `<ul class="nav nav-tabs mb-2">`;
    vcKeys.forEach((vc, idx) => {
      html += `<li class="nav-item"><button class="nav-link ${idx === 0 ? "active" : ""}" data-bs-toggle="tab" data-bs-target="#tab-${idx}">${vc}</button></li>`;
    });
    html += `</ul><div class="tab-content">`;
    vcKeys.forEach((vc, idx) => {
      html += `<div class="tab-pane fade ${idx === 0 ? "show active" : ""}" id="tab-${idx}">
        <table class="table table-sm table-bordered">
          <thead><tr><th>Stage</th><th>Impact</th><th>Strategy</th></tr></thead>
          <tbody>`;
      strategyDataByVC[vc].forEach(r => {
        html += `<tr><td>${r.stage}</td><td>${r.risk}</td><td>${r.strategy}</td></tr>`;
      });
      html += `</tbody></table></div>`;
    });
    html += `</div></div>`;

    document.getElementById("modal-content-placeholder").innerHTML = html;
    new bootstrap.Modal(document.getElementById("strategyModal")).show();

    const selectedGroup = groupNames.find(
      g => timeseriesGroups[g].layer_name === defaultGroup
    ) || groupNames[0];
    renderTimeseriesChart(selectedGroup);
  });
}

function renderTimeseriesChart(group) {
  const ctx = document.getElementById("ts-chart").getContext("2d");
  const raw = timeseriesGroups[group] || { data: [] };
  const data = raw.data;

  const chartData = {
    labels: data.map(d => d.year),
    datasets: [{
      label: `${group} (${data.length > 0 ? 'values' : 'no data'})`,
      data: data.map(d => d.value),
      borderColor: "#007bff",
      pointBackgroundColor: "#007bff",
      tension: 0.3,
      fill: false
    }]
  };

  const chartOptions = {
    responsive: true,
    plugins: {
      tooltip: { mode: 'index', intersect: false },
      legend: { display: true },
      title: {
        display: true,
        text: `Time Series – ${group}`,
        font: { size: 16 }
      }
    },
    scales: {
      x: { title: { display: true, text: 'Year' } },
      y: { title: { display: true, text: 'Value' } }
    }
  };

  if (window.tsChart) window.tsChart.destroy();
  window.tsChart = new Chart(ctx, {
    type: "line",
    data: chartData,
    options: chartOptions
  });
}


function toggleView(view) {
  const btns = document.querySelectorAll(".btn-group .btn");
  btns.forEach(btn => btn.classList.remove("active"));

  if (view === 'timeseries') {
    document.getElementById("view-timeseries").style.display = '';
    document.getElementById("view-strategies").style.display = 'none';
    btns[0].classList.add("active");
  } else {
    document.getElementById("view-timeseries").style.display = 'none';
    document.getElementById("view-strategies").style.display = '';
    btns[1].classList.add("active");
  }
}


function groupBy(array, key) {
  return array.reduce((acc, item) => {
    const k = item[key] || "Unnamed";
    acc[k] = acc[k] || [];
    acc[k].push(item);
    return acc;
  }, {});
}
</script>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>{% trans "Hazard Map Viewer" %}</h5>
        </div>
        <div class="card-body position-relative">
          <div id="map" class="mb-3"></div>
          <div class="control-panel">
            <label for="hazard-type-select" class="form-label fw-bold">{% trans "Hazard Type" %}</label>
            <select id="hazard-type-select" class="form-select form-select-sm mb-2">
              <option value="">{% trans "-- Select type --" %}</option>
            </select>
            <label for="hazard-layer-select" class="form-label fw-bold">{% trans "Layer" %}</label>
            <select id="hazard-layer-select" class="form-select form-select-sm">
              <option value="">{% trans "-- Select layer --" %}</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="strategyModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title text-white">{% trans "Adaptation Strategies & Time Series" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modal-content-placeholder"></div>
    </div>
  </div>
</div>
{% endblock %}
