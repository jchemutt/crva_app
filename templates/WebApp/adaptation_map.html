{% extends "WebApp/app_base.html" %}
{% load static i18n %}

{% block title %}{% trans "Adaptation Map" %}{% endblock %}

{% block script %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-loading@0.1.23/src/Control.Loading.css" />

<style>
  /* Map height */
  #map { height: 75vh; border-radius: 8px; }
  @media (max-width: 576px){ #map { height: 65vh; } }

  /* Leaflet controls placement */
  .leaflet-top.leaflet-left { top: 12px !important; left: 12px !important; }

  /* Instructions box (desktop) / drawer (mobile) */
  .legend-box{
    position: absolute; top: 90px; right: 20px; z-index: 999;
    background: #fff; padding: 12px 15px; border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,.15); font-size: .9rem; max-width: 300px;
    touch-action: pan-y;
  }
  /* Toggle button (only on small screens) */
  .legend-toggle-fab{
    position: absolute; right: 16px; bottom: 16px; z-index: 1000;
    border: 0; border-radius: 999px; width: 44px; height: 44px;
    display: none; align-items: center; justify-content: center;
    background: #198754; color: #fff; box-shadow: 0 6px 16px rgba(0,0,0,.25);
  }
  .legend-toggle-fab:active{ transform: translateY(1px); }

  @media (max-width: 768px){
    .legend-box{
      top: auto; right: 0; left: 0; bottom: 0; max-width: none;
      margin: 0; border-radius: 12px 12px 0 0; width: 100%;
      padding: 10px 14px; box-shadow: 0 -6px 18px rgba(0,0,0,.2);
      transform: translateY(100%); transition: transform .25s ease;
    }
    .legend-box.open{ transform: translateY(0); }
    .legend-toggle-fab{ display: inline-flex; }
  }

  .hazard-badge { cursor: pointer; display: inline-block; margin: 2px 2px; }
  .hazard-badge.active { background-color: #007847 !important; color: #fff !important; }

  .vc-label {
    background: #007847; color: #fff; border-radius: 50%;
    width: 28px; height: 28px; text-align: center; line-height: 26px;
    font-size: 13px; font-weight: bold; border: 2px solid #fff;
    box-shadow: 0 0 4px #00000050;
  }

  .vc-icon { font-size: 14px; margin-right: 4px; }

  .leaflet-popup-content.wide-popup { font-size: 0.95rem; }
  .leaflet-popup-content-wrapper.wide-popup { max-width: 600px; }
  @media (max-width: 576px){
    .leaflet-popup-content-wrapper.wide-popup { max-width: 90vw; }
  }

  /* Always-on, non-interactive VC chips overlay */
  .vc-stack{
    display: inline-flex; gap: 6px; padding: 6px 8px; background: rgba(255,255,255,.9);
    border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.15); align-items: center;
    border: 1px solid rgba(0,0,0,.06); pointer-events: none; backdrop-filter: blur(2px);
    font-size: 13px; line-height: 1.2;
  }
  .vc-stack .vc-name { font-weight: 600; color: #2b2b2b; margin-right: 2px; }
  .vc-stack .vc-chip{
    display: inline-flex; align-items: center; gap: 4px;
    padding: 2px 6px; border-radius: 999px; background: #f1f3f5; border: 1px solid #e9ecef; white-space: nowrap;
  }
  .vc-stack .vc-chip i { font-size: 13px; }

  /* Floating WMS legend (matching your style) */
  .leaflet-bottom.leaflet-right { right: 10px; bottom: 10px; }
  .legend-control{
    background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,.15);
    overflow: hidden; width: 260px; max-height: 320px; display: none; touch-action: pan-y;
  }
  .legend-header{
    display: flex; align-items: center; justify-content: space-between; gap: 8px;
    padding: 8px 10px; background: #198754; color: #fff; font-weight: 600; font-size: 0.95rem;
  }
  .legend-body { padding: 8px 10px; max-height: 270px; overflow: auto; }
  .legend-body img { width: 100%; height: auto; display: block; }

  /* Table responsiveness */
  @media (max-width: 576px){
    #strategy-table { font-size: 12px; }
    #strategy-table th, #strategy-table td { white-space: normal; }
  }
</style>

<script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-loading@0.1.23/src/Control.Loading.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

<script>
/* Safe no-op for gettext if the JS catalog isn't loaded */
if (typeof window.gettext !== 'function') { window.gettext = function(s){ return s; }; }

let map, currentStrategyData = [], currentProvinceId, currentValueChainId,currentHazardId,currentValueChain, currentHazard;

// --- icons for VCs
const vcIcons = {
  1: "<i class='fas fa-seedling text-success vc-icon'></i>",   // Sesame
  2: "<i class='fas fa-leaf text-primary vc-icon'></i>",       // Cassava
  3: "<i class='fas fa-tractor text-warning vc-icon'></i>",    // Maize
  4: "<i class='fas fa-paw text-secondary vc-icon'></i>",      // Goats
  5: "<i class='fas fa-cow text-danger vc-icon'></i>",         // Cattle
  6: "<i class='fas fa-water text-info vc-icon'></i>",         // Rice
  7: "<i class='fas fa-seedling text-muted vc-icon'></i>",     // Groundnuts
  8: "<i class='fas fa-smoking text-success vc-icon'></i>",    // Tobacco
  9: "<i class='fas fa-industry text-purple vc-icon'></i>"     // Sugarcane
};

// --- GeoServer WMS provinces (geometry stays server-side)
const PROV_WMS_URL = "https://crva.jcdevops.com/geoserver/wms";
const PROV_LAYER   = "crva:provinces";
const PROV_STYLE   = "province_boundaries";  

// --- Lightweight summaries (no geometry)
const PROV_SUMMARY_URL = "/api/province-summaries/";

const provinceSummariesById = new Map(); // id -> summary
let vcOverlayMarkers = [];
let vcCountMarkers = [];
let legendControl;

/* ---------- Legend Control ---------- */
const LegendControl = L.Control.extend({
  onAdd: function() {
    const div = L.DomUtil.create("div", "legend-control");
    div.innerHTML = `
      <div class="legend-header">
        <span>{% trans "Legend" %}</span>
        <button class="legend-toggle" title="{% trans 'Collapse/Expand' %}" aria-label="{% trans 'Collapse/Expand' %}">–</button>
      </div>
      <div class="legend-body">
        <img id="legend-image" alt="Legend">
      </div>
    `;
    L.DomEvent.disableClickPropagation(div);
    const toggleBtn = div.querySelector(".legend-toggle");
    const body = div.querySelector(".legend-body");
    toggleBtn.addEventListener("click", () => {
      const isHidden = body.style.display === "none";
      body.style.display = isHidden ? "" : "none";
      toggleBtn.textContent = isHidden ? "–" : "+";
    });
    return div;
  }
});

// Set the legend image to the provinces layer GetLegendGraphic
function setBoundaryLegend() {
  const params = new URLSearchParams({
    REQUEST: "GetLegendGraphic",
    VERSION: "1.0.0",
    FORMAT: "image/png",
    TRANSPARENT: "true",
    LAYER: PROV_LAYER,
    LEGEND_OPTIONS: "fontName:Arial;fontSize:12;fontAntiAliasing:true;forceLabels:on",
    _ts: Date.now().toString()
  });
  if (PROV_STYLE) params.set("STYLE", PROV_STYLE);

  const legendUrl = `${PROV_WMS_URL}?${params.toString()}`;
  const el = legendControl.getContainer();
  el.style.display = "block";
  el.querySelector("#legend-image").src = legendUrl;
}

// CSV export
function exportToCSV() {
  let csv = "Stage,Impact,Adaptation Strategy\n";
  currentStrategyData.forEach(r => {
    csv += `"${r.stage}","${r.risk}","${r.strategy}"\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${currentValueChain}_${currentHazard}_adaptation.csv`;
  a.click();
}

// DataTable
function populateStrategyTable(data) {
  const stageOrder = [
    "Provision of inputs",
    "On farm production",
    "Post harvest and local processing",
    "Product marketing",
    "Consumption"
  ];
  const orderedData = [...data].sort((a, b) => stageOrder.indexOf(a.stage) - stageOrder.indexOf(b.stage));

  if ($.fn.DataTable.isDataTable("#strategy-table")) {
    $("#strategy-table").DataTable().clear().destroy();
  }

  const tbody = document.getElementById("strategy-table-body");
  tbody.innerHTML = "";
  orderedData.forEach(r => {
    tbody.innerHTML += `
      <tr>
        <td style="width: 15%;"><span class="badge bg-info text-dark">${r.stage}</span></td>
        <td style="width: 42%;">${r.risk}</td>
        <td style="width: 43%;">${r.strategy || ""}</td>
      </tr>`;
  });

  $("#strategy-table").DataTable({ order: [], autoWidth: false, destroy: true });
}

// Modal open
function showStrategyModal(provinceId, vcId, vcName, hzId, hzName) {
  currentProvinceId = provinceId;
  currentValueChainId = vcId;
  currentHazardId = hzId;
  currentValueChainName = vcName;
  currentHazardName = hzName;

  const provinceSummary = provinceSummariesById.get(provinceId);
  const provinceName = provinceSummary?.name || gettext("Unknown");

  // badges (translated names)
  document.getElementById("selected-province").innerText = provinceName;
  document.getElementById("selected-vc").innerText = vcName;
  document.getElementById("selected-hazard").innerText = hzName;

  const apiUrl = `/api/strategies/?province=${provinceId}` +
                 `&value_chain=${vcId}` +
                 `&hazard=${hzId}` +
                 `&_=${Date.now()}`;

  fetch(apiUrl, { cache: "no-store" })
    .then(res => res.json())
    .then(data => {
      currentStrategyData = data;
      populateStrategyTable(data);

      // highlight selected hazard chip in popup (if present)
          document.querySelectorAll(".hazard-badge").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(
        `.hazard-badge[data-vc-id='${vcId}'][data-hz-id='${hzId}']`
      ).forEach(el => el.classList.add("active"));

      new bootstrap.Modal(document.getElementById('strategyModal')).show();
    })
    .catch(err => console.error("Error fetching strategies:", err));
}

// Build always-on VC overlay HTML (name + chips)
function overlayHtmlFor(summary) {
  const vcs = summary.value_chains || [];
  if (!vcs.length) return "";
  const chips = vcs.map(vc => {
    const icon = vcIcons[vc.id] || "<i class='fas fa-leaf vc-icon'></i>";
    return `<span class="vc-chip">${icon}<span>${vc.name}</span></span>`;
  }).join("");
  return `<div class="vc-stack"><span class="vc-name">${summary.name}</span>${chips}</div>`;
}

// Build popup (opened when user clicks numeric circle)
function popupHtmlFor(summary) {
  const vcs = summary.value_chains || [];
  if (!vcs.length) {
    return `<h6><i class='fas fa-map-marker-alt text-success me-1'></i>${summary.name}</h6>
            <hr class='my-1'>
            <div class="text-muted">No value-chain data available yet.</div>`;
  }

  let html = `<h6><i class='fas fa-map-marker-alt text-success me-1'></i>${summary.name}</h6><hr class='my-1'>`;

  vcs.forEach(vc => {
    const icon = vcIcons[vc.id] || "<i class='fas fa-leaf vc-icon'></i>";
    html += `<strong>${icon}${vc.name}</strong><br>`;

    (summary.hazards_by_vc[vc.id] || []).forEach(hz => {
      html += `<span class='badge bg-info text-dark hazard-badge'
                 onclick="showStrategyModal(${summary.id}, ${vc.id}, '${vc.name}', ${hz.id}, '${hz.name}')"
                 data-vc-id='${vc.id}' data-hz-id='${hz.id}'>${hz.name}</span> `;
    });

    html += "<hr class='my-1'>";
  });

  return html;
}


// Render overlays (chips) + numeric count circles
async function renderProvinceOverlays() {
  map.fire("dataloading");
  try {
    const summaries = await fetch(PROV_SUMMARY_URL, { cache: "no-store" }).then(r => r.json());

    provinceSummariesById.clear();
    vcOverlayMarkers.forEach(m => map.removeLayer(m));
    vcCountMarkers.forEach(m => map.removeLayer(m));
    vcOverlayMarkers = [];
    vcCountMarkers = [];

    summaries.forEach(s => {
      provinceSummariesById.set(s.id, s);
      if (!s?.centroid) return;

      const count = (s.value_chains || []).length;
      if (count === 0) return;

      // Overlay chips
      const html = overlayHtmlFor(s);
      if (html) {
        const overlayIcon = L.divIcon({ className: "", html, iconSize: null, iconAnchor: [0, 0] });
        const overlayMarker = L.marker([s.centroid.lat, s.centroid.lng], { icon: overlayIcon, interactive: false }).addTo(map);
        vcOverlayMarkers.push(overlayMarker);
      }


      // Count circle (clickable)
      const circleIcon = L.divIcon({ className: 'vc-label', html: count, iconSize: [30, 30], iconAnchor: [15, 15] });
      const circleMarker = L.marker([s.centroid.lat, s.centroid.lng], { icon: circleIcon })
        .on("click", () => {
          const html = popupHtmlFor(s);
          const legendWidth = 280 + 20 + 20;
          L.popup({
            maxWidth: 600,
            minWidth: (window.innerWidth < 576 ? 260 : 500),
            className: 'wide-popup',
            autoPan: true,
            autoPanPaddingTopLeft: [20, 20],
            autoPanPaddingBottomRight: [legendWidth, 20]
          })
          .setLatLng([s.centroid.lat, s.centroid.lng])
          .setContent(html)
          .openOn(map);
        })
        .addTo(map);
      vcCountMarkers.push(circleMarker);
    });
  } finally {
    map.fire("dataload");
  }
}

document.addEventListener("DOMContentLoaded", () => {
  map = L.map('map', { loadingControl: true }).setView([-17.6, 36.9], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  // Provinces as WMS (no client geometry)
  L.tileLayer.wms(PROV_WMS_URL, {
    layers: PROV_LAYER,
    styles: PROV_STYLE || undefined,
    format: "image/png",
    transparent: true,
    version: "1.1.1",
    tiled: true
  }).addTo(map);

  // Province legend
  legendControl = new LegendControl({ position: "bottomright" }).addTo(map);
  setBoundaryLegend();

  renderProvinceOverlays();

  // Declutter chips text at low zoom
  map.on("zoomend", () => {
    const showText = map.getZoom() >= 6;
    vcOverlayMarkers.forEach(m => {
      const el = m.getElement();
      if (!el) return;
      el.querySelectorAll(".vc-chip span").forEach(span => {
        span.style.display = showText ? "" : "none";
      });
    });
  });

  // Mobile: legend/instructions drawer toggle
  const fab = document.getElementById("legendToggleFab");
  const box = document.getElementById("legendBox");
  if (fab && box){
    fab.addEventListener("click", () => box.classList.toggle("open"));
  }

  // Keep popup class clean on modal close (your original behavior)
  const modal = document.getElementById('strategyModal');
  modal.addEventListener('hidden.bs.modal', () => {
    const popup = map._popup;
    if (popup) popup._container?.classList?.remove("leaflet-popup-content-wrapper");
  });
});
</script>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-lg-12 mb-4">
      <div class="card shadow border-0">
        <div class="card-header text-white" style="background: linear-gradient(90deg, #007847, #66bb6a);">
          <h5 class="m-0"><i class="fas fa-map-marked-alt me-2"></i>{% trans "Climate Adaptation Strategies Map" %}</h5>
        </div>
        <div class="card-body position-relative">
          <div id="map" class="mb-3"></div>

          <!-- Instructions / Legend -->
          <button id="legendToggleFab" class="legend-toggle-fab" type="button" aria-label="{% trans 'Toggle instructions' %}">
            <i class="fas fa-info"></i>
          </button>
          <div id="legendBox" class="legend-box">
            <strong class="d-block mb-2"><i class="fas fa-circle text-success"></i> {% trans "Instructions" %}</strong>
            <ul class="mb-2 ps-3">
              <li>{% trans "Click a province circle to open value chains" %}</li>
              <li>{% trans "Click hazard badge to view strategies" %}</li>
              <li>{% trans "Download table as CSV from modal" %}</li>
            </ul>
          </div>
          <!-- /Instructions -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Strategy Modal (fullscreen on small devices) -->
<div class="modal fade" id="strategyModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-fullscreen-sm-down modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="fas fa-lightbulb me-2"></i>{% trans "Key Value Chains and Risks" %}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Selected Context Info -->
        <div class="mb-3">
          <div class="d-flex flex-wrap gap-3">
            <div><strong>{% trans "Province" %}:</strong> <span id="selected-province" class="badge bg-primary"></span></div>
            <div><strong>{% trans "Value Chain" %}:</strong> <span id="selected-vc" class="badge bg-success"></span></div>
            <div><strong>{% trans "Hazard" %}:</strong> <span id="selected-hazard" class="badge bg-warning text-dark"></span></div>
          </div>
        </div>

        <!-- Export Button -->
        <div class="d-flex justify-content-end mb-2">
          <button class="btn btn-sm btn-outline-secondary me-2" onclick="exportToCSV()">
            <i class="fas fa-file-csv"></i> {% trans "CSV" %}
          </button>
        </div>

        <!-- Strategies Table -->
        <div class="table-responsive">
          <table id="strategy-table" class="table table-bordered table-hover table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>{% trans "Stage" %}</th>
                <th>{% trans "Impact" %}</th>
                <th>{% trans "Adaptation Strategy" %}</th>
              </tr>
            </thead>
            <tbody id="strategy-table-body"></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}
